# 实现计划: RAG 知识库系统

## 概述

本实现计划将 nanobot 知识库系统从基于 JSON 文件的存储改造为基于 Chroma 向量数据库的 RAG 系统。实现将分为以下几个阶段：依赖安装、核心组件开发、系统集成、测试验证。

## 任务

- [x] 1. 安装依赖和项目配置
  - 在 pyproject.toml 中添加 chromadb、sentence-transformers、langchain 等依赖
  - 创建 RAG 配置类和环境变量支持
  - _需求: 1.1, 3.4, 3.5, 7.1, 7.2, 7.3, 7.4_

- [ ] 2. 实现文本向量化组件
  - [x] 2.1 实现 VectorEmbedder 类
    - 实现 Embedding 模型加载和缓存
    - 实现单文本向量化方法 embed_text
    - 实现批量向量化方法 embed_batch
    - 添加错误处理（模型加载失败、向量化失败）
    - _需求: 3.4, 3.5, 3.6, 8.2_
  
  - [x] 2.2 为 VectorEmbedder 编写属性测试
    - **属性 1**: 对于任意文本，向量化后的结果维度应该与模型输出维度一致
    - **验证需求**: 需求 3.4
  
  - [x] 2.3 为 VectorEmbedder 编写单元测试
    - 测试模型加载成功
    - 测试单文本向量化
    - 测试批量向量化
    - 测试模型不存在时抛出异常
    - _需求: 3.4, 3.5, 8.2_

- [ ] 3. 实现文本分块组件
  - [x] 3.1 实现 TextChunker 类
    - 使用 LangChain RecursiveCharacterTextSplitter
    - 实现 chunk_text 方法，支持元数据保留
    - 配置中文友好的分隔符（段落、句子、标点）
    - _需求: 3.1, 3.2, 3.3_
  
  - [x] 3.2 为 TextChunker 编写属性测试
    - **属性 2**: 长文本自动分块
    - **属性 3**: 分块元数据完整性
    - **验证需求**: 需求 3.1, 3.3
  
  - [x] 3.3 为 TextChunker 编写单元测试
    - 测试短文本不分块
    - 测试长文本分块
    - 测试元数据保留
    - _需求: 3.1, 3.3_

- [ ] 4. 实现 Chroma 数据库集成
  - [x] 4.1 实现 ChromaKnowledgeStore 初始化
    - 初始化 Chroma 持久化客户端
    - 创建知识库目录结构
    - 实现集合创建和获取方法 _get_or_create_collection
    - 加载初始化状态文件
    - _需求: 1.2, 1.3, 1.4, 1.5, 2.1, 2.4_
  
  - [x] 4.2 为 Chroma 初始化编写单元测试
    - 测试数据库目录创建
    - 测试 Chroma 客户端初始化
    - 测试集合创建
    - 测试连接失败时抛出异常
    - _需求: 1.2, 1.3, 1.4, 8.1_

- [x] 5. 检查点 - 确保核心组件测试通过
  - 确保所有测试通过，如有问题请向用户提问

- [ ] 6. 实现知识库初始化逻辑
  - [x] 6.1 实现版本控制和智能初始化
    - 实现 _should_reinitialize 方法检查版本变化
    - 实现 _auto_initialize_builtin_knowledge 方法
    - 更新 RocketMQKnowledgeInitializer 以支持向量化
    - 实现批量向量化和存储到 Chroma
    - _需求: 2.1, 2.2, 2.3, 2.5, 2.6_
  
  - [x] 6.2 为初始化逻辑编写单元测试
    - 测试首次初始化加载所有知识
    - 测试版本变化时重新初始化
    - 测试版本未变化时跳过初始化
    - 测试初始化状态文件更新
    - _需求: 2.2, 2.3, 2.4, 2.5_

- [ ] 7. 实现语义检索功能
  - [x] 7.1 实现 search_knowledge 方法
    - 实现查询文本向量化
    - 实现 Chroma 相似度搜索
    - 实现元数据过滤（domain、category、tags）
    - 实现结果重构为 KnowledgeItem
    - 添加相似度分数到结果
    - _需求: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6, 4.7, 4.8_
  
  - [x] 7.2 为语义检索编写属性测试
    - **属性 4**: 元数据过滤正确性
    - **属性 5**: 检索结果排序
    - **验证需求**: 需求 4.4, 4.5, 4.6, 4.8
  
  - [x] 7.3 为语义检索编写单元测试
    - 测试基本语义检索
    - 测试按领域过滤
    - 测试按分类过滤
    - 测试按标签过滤
    - 测试返回结果数量限制
    - 测试相似度分数存在
    - _需求: 4.3, 4.4, 4.5, 4.6, 4.7_

- [ ] 8. 实现增量更新功能
  - [x] 8.1 实现 add_knowledge 方法
    - 创建 KnowledgeItem
    - 文本分块
    - 批量向量化
    - 存储到 Chroma 集合
    - _需求: 5.1_
  
  - [x] 8.2 实现 update_knowledge 方法
    - 删除旧的向量数据
    - 更新内容并重新向量化
    - 存储新的向量数据
    - _需求: 5.2_
  
  - [x] 8.3 实现 delete_knowledge 方法
    - 从 Chroma 集合中删除所有相关分块
    - _需求: 5.3_
  
  - [x] 8.4 为增量更新编写属性测试
    - **属性 6**: 增量添加一致性
    - **属性 7**: 增量更新一致性
    - **属性 8**: 增量删除一致性
    - **验证需求**: 需求 5.1, 5.2, 5.3
  
  - [x] 8.5 为增量更新编写单元测试
    - 测试添加知识后可检索
    - 测试更新知识后内容变化
    - 测试删除知识后不可检索
    - 测试更新失败时回滚
    - _需求: 5.1, 5.2, 5.3, 5.5_

- [x] 9. 检查点 - 确保所有核心功能测试通过
  - 确保所有测试通过，如有问题请向用户提问

- [ ] 10. 实现辅助方法和 API 兼容性
  - [x] 10.1 实现元数据查询方法
    - 实现 get_domains 方法
    - 实现 get_categories 方法
    - 实现 get_tags 方法
    - _需求: 6.1, 6.2_
  
  - [x] 10.2 更新 DomainKnowledgeManager
    - 确保所有方法与新的 ChromaKnowledgeStore 兼容
    - 测试 API 兼容性
    - _需求: 6.2, 6.3_
  
  - [x] 10.3 为 API 兼容性编写单元测试
    - 测试 KnowledgeStore 接口保持不变
    - 测试 DomainKnowledgeManager 接口保持不变
    - 测试有 query 参数时使用语义检索
    - 测试无 query 参数时使用元数据过滤
    - _需求: 6.1, 6.2, 6.3, 6.4, 6.5_

- [ ] 11. 实现配置管理
  - [x] 11.1 实现 RAGConfig 类
    - 定义所有配置参数
    - 实现 from_env 方法从环境变量加载
    - 实现配置验证和默认值
    - _需求: 7.1, 7.2, 7.3, 7.4, 7.5_
  
  - [x] 11.2 为配置管理编写单元测试
    - 测试从环境变量加载配置
    - 测试配置默认值
    - 测试无效配置使用默认值
    - _需求: 7.1, 7.2, 7.4, 7.5_

- [ ] 12. 实现错误处理和日志
  - [x] 12.1 定义异常类
    - 实现 RAGKnowledgeError 基类
    - 实现 ChromaConnectionError
    - 实现 EmbeddingModelError
    - 添加详细的错误消息和解决建议
    - _需求: 8.1, 8.2, 8.6_
  
  - [x] 12.2 添加结构化日志
    - 在关键操作处添加日志（初始化、检索、更新）
    - 添加操作耗时记录
    - 添加错误和警告日志
    - _需求: 8.3, 8.4, 8.5_
  
  - [x] 12.3 为错误处理编写单元测试
    - 测试 Chroma 连接失败抛出异常
    - 测试 Embedding 模型不可用抛出异常
    - 测试单个条目失败继续处理
    - _需求: 8.1, 8.2, 8.3_

- [ ] 13. 性能优化
  - [x] 13.1 实现批量处理
    - 实现批量向量化方法
    - 优化 Chroma 批量插入
    - _需求: 9.2_
  
  - [x] 13.2 实现模型缓存
    - 缓存 Embedding 模型实例
    - 避免重复加载
    - _需求: 9.3_
  
  - [x] 13.3 为性能优化编写测试
    - 测试检索结果数量小于请求时返回所有结果
    - 测试大量数据的检索性能
    - _需求: 9.4_

- [ ] 14. 集成测试和端到端测试
  - [x] 14.1 编写端到端测试
    - 测试完整的 RAG 工作流程（初始化→添加→检索→更新→删除）
    - 测试 RocketMQ 知识库初始化和检索
    - _需求: 10.3_
  
  - [x] 14.2 编写性能测试
    - 测试大量知识条目的检索响应时间
    - 测试批量向量化性能
    - _需求: 10.4_

- [ ] 15. 更新文档和示例
  - [x] 15.1 更新 README.md
    - 添加 RAG 系统使用说明
    - 添加配置示例
    - 添加故障排查指南
    - _需求: 6.1, 7.1_
  
  - [x] 15.2 创建迁移指南
    - 说明从旧系统迁移的步骤
    - 说明 API 变化（如果有）
    - _需求: 6.1_

- [x] 16. 最终检查点 - 确保所有测试通过
  - 运行所有单元测试
  - 运行所有属性测试
  - 运行集成测试和端到端测试
  - 确认所有功能正常，如有问题请向用户提问

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以跳过以加快 MVP 开发
- 每个任务都引用了具体的需求编号，确保可追溯性
- 检查点任务确保增量验证，及早发现问题
- 属性测试验证通用正确性属性，单元测试验证具体示例和边缘情况
- 所有属性测试应配置为运行至少 100 次迭代
