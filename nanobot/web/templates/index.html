<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>RocketMQ AI Agent</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            margin: 0;
            padding: 0;
            display: flex;
        }

        .chat-container {
            width: 100%;
            height: 100vh;
            background: white;
            border-radius: 0;
            box-shadow: none;
            display: flex;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: white;
            text-align: center;
        }

        .sidebar-content {
            flex: 1;
            padding: 40px 20px;
            color: #718096;
            font-size: 0.9rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background: #2d3748;
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .chat-header .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 5px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8fafc;
        }

        .input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: border-color 0.3s;
        }

        #messageInput:focus {
            border-color: #4299e1;
        }

        #sendButton {
            padding: 15px 25px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1rem;
            transition: background 0.3s;
        }

        #sendButton:hover {
            background: #3182ce;
        }

        #sendButton:disabled {
            background: #a0aec0;
            cursor: not-allowed;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: fadeIn 0.3s ease-in;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.ai {
            justify-content: flex-start;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .user .avatar {
            background: #4299e1;
            color: white;
        }

        .ai .avatar {
            background: #48bb78;
            color: white;
        }

        .message-content {
            max-width: 70%;
            padding: 15px 20px;
            border-radius: 20px;
            position: relative;
        }

        .user .message-content {
            background: #4299e1;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .ai .message-content {
            background: white;
            color: #2d3748;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 5px;
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 1px solid #e2e8f0;
        }

        .iteration-info {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
            background: #edf2f7;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .duration-info {
            font-size: 0.8rem;
            color: #718096;
        }

        .timestamp {
            font-size: 0.8rem;
            color: #a0aec0;
        }

        /* æµå¼å†…å®¹åˆ†ç±»æ˜¾ç¤ºæ ·å¼ */
        .streaming-sections {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .streaming-section {
            border-left: 4px solid #e2e8f0;
            padding-left: 15px;
            margin: 5px 0;
        }

        .streaming-section-reasoning {
            border-left-color: #4299e1;
            background: rgba(66, 153, 225, 0.05);
        }

        .streaming-section-thinking {
            border-left-color: #4299e1;
            background: rgba(66, 153, 225, 0.05);
        }

        .streaming-section-tool {
            border-left-color: #48bb78;
            background: rgba(72, 187, 120, 0.05);
        }

        .streaming-section-answer {
            border-left-color: #ed8936;
            background: rgba(237, 137, 54, 0.05);
        }

        .streaming-section-knowledge {
            border-left-color: #9f7aea;
            background: rgba(159, 122, 234, 0.05);
        }

        /* Reasoningå†…å®¹æ ·å¼ */
        .reasoning-duration {
            font-size: 0.8rem;
            color: #718096;
            margin-top: 5px;
            padding: 3px 8px;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 4px;
            display: inline-block;
            border-left: 2px solid #4299e1;
        }

        /* å·¥å…·æ‰§è¡ŒåŒºåŸŸæ ·å¼ */
        .tool-section {
            border-left: 4px solid #48bb78;
            background: rgba(72, 187, 120, 0.05);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .tool-status-start {
            color: #3182ce;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .tool-status-completed {
            color: #38a169;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .tool-status-error {
            color: #e53e3e;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .tool-details {
            margin-top: 8px;
            padding-left: 10px;
            border-left: 2px solid #e2e8f0;
        }

        .tool-duration {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 3px;
        }

        .tool-result, .tool-error {
            font-size: 0.9rem;
            color: #4a5568;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* çŸ¥è¯†åº“æŸ¥è¯¢åŒºåŸŸæ ·å¼ */
        .knowledge-section {
            border-left: 4px solid #9f7aea;
            background: rgba(159, 122, 234, 0.05);
            padding: 10px 15px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .knowledge-status-start {
            color: #805ad5;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .knowledge-status-searching {
            color: #6b46c1;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .knowledge-status-success {
            color: #38a169;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .knowledge-status-no-results {
            color: #d69e2e;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .knowledge-status-error {
            color: #e53e3e;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .knowledge-status-skipped {
            color: #718096;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .knowledge-details {
            margin-top: 8px;
            padding-left: 10px;
            border-left: 2px solid #e2e8f0;
        }

        .knowledge-query-info {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 3px;
        }

        .knowledge-result {
            font-size: 0.9rem;
            color: #4a5568;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.7);
            padding: 8px;
            border-radius: 4px;
            margin-top: 5px;
        }

        .knowledge-count {
            display: inline-block;
            background: #9f7aea;
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .section-header {
            margin-bottom: 8px;
        }

        .section-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #4a5568;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .streaming-content {
            font-size: 1rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #48bb78;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes typing {
            0%, 60%, 100% { transform: scale(1); opacity: 1; }
            30% { transform: scale(1.2); opacity: 0.7; }
        }

        .processing-time {
            font-size: 0.8rem;
            color: #48bb78;
            font-weight: 600;
            margin-top: 3px;
            padding: 4px 8px;
            background: rgba(72, 187, 120, 0.1);
            border-radius: 6px;
            display: inline-block;
            border-left: 3px solid #48bb78;
        }

        .processing-time div {
            margin: 2px 0;
        }

        .processing-time div:first-child {
            color: #4299e1;
            font-weight: 700;
        }

        .processing-time div:last-child {
            color: #ed8936;
            font-weight: 600;
        }

        .streaming {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
<div class="chat-container">
    <!-- å·¦ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h2>ğŸ¤– Taether</h2>
            <div class="subtitle">RocketMQ AI Agent</div>
        </div>
        <div class="sidebar-content">
            <div>
                <p>ğŸš§ åŠŸèƒ½å¼€å‘ä¸­</p>
                <p style="font-size: 0.8rem; margin-top: 10px;">å·¦ä¾§è¾¹æ å°†ç”¨äºæ˜¾ç¤ºå†å²å¯¹è¯ã€è®¾ç½®ç­‰åŠŸèƒ½</p>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="chat-header">
            <h1>ğŸ¤– RocketMQ AI Agent</h1>
            <div class="subtitle">for tce and tcs</div>
        </div>

        <div class="messages-container" id="messages">
            <div class="message ai">
                <div class="avatar">AI</div>
                <div class="message-content">
                    Hello! I'm Taether, your rocketmq assistant. How can I help you today?
                    <div class="timestamp">Just now</div>
                </div>
            </div>
        </div>

        <div class="input-container">
            <div class="input-wrapper">
                <input autocomplete="off" id="messageInput" placeholder="Ask me about rocketmq..." type="text">
                <button id="sendButton" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>
</div>

<script>
    const ws = new WebSocket("ws://localhost:8000/ws");
    const messagesDiv = document.getElementById("messages");
    const messageInput = document.getElementById("messageInput");
    const sendButton = document.getElementById("sendButton");
    let isTyping = false;
    let isProcessing = false; // æ ‡è®°æ˜¯å¦æ­£åœ¨å¤„ç†è¯·æ±‚

    // Auto-scroll to bottom
    function scrollToBottom() {
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Add user message
    function addUserMessage(content) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message user';
        messageDiv.innerHTML = `
            <div class="message-content">
                ${content}
                <div class="timestamp">${new Date().toLocaleTimeString()}</div>
            </div>
            <div class="avatar">U</div>
        `;
        messagesDiv.appendChild(messageDiv);
        scrollToBottom();
    }

    // Add AI message
    function addAIMessage(content, totalTime = null, llmTime = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = 'message ai';

        // å°†\\næ›¿æ¢ä¸ºå®é™…çš„æ¢è¡Œç¬¦
        const formattedContent = content.replace(/\\n/g, '<br />');

        let timeInfo = `<div class=\"timestamp\">${new Date().toLocaleTimeString()}</div>`;
        if (totalTime && llmTime) {
            timeInfo += `
                <div class=\"processing-time\">
                    <div>æ€»è€—æ—¶: ${totalTime}ç§’</div>
                    <div>LLMæ‰§è¡Œè€—æ—¶: ${llmTime}ç§’</div>
                </div>
            `;
        } else if (totalTime) {
            timeInfo += `<div class=\"processing-time\">æ€»è€—æ—¶: ${totalTime}ç§’</div>`;
        }

        messageDiv.innerHTML = `
            <div class=\"avatar\">AI</div>
            <div class=\"message-content\">
                ${formattedContent}
                ${timeInfo}
            </div>
        `;
        messagesDiv.appendChild(messageDiv);
        scrollToBottom();
    }

    // Show typing indicator
    function showTypingIndicator() {
        if (isTyping) return;
        isTyping = true;

        const typingDiv = document.createElement('div');
        typingDiv.className = 'message ai';
        typingDiv.id = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="avatar">AI</div>
            <div class="message-content">
                <div class="typing-indicator">
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            </div>
        `;
        messagesDiv.appendChild(typingDiv);
        scrollToBottom();
    }

    // Hide typing indicator
    function hideTypingIndicator() {
        const typingDiv = document.getElementById('typing-indicator');
        if (typingDiv) {
            typingDiv.remove();
        }
        isTyping = false;
    }

    // WebSocket message handling for streaming responses
    let currentAIMessage = null;
    let isStreaming = false;
    let currentStreamingSections = {}; // å­˜å‚¨ä¸åŒç±»å‹çš„æµå¼å†…å®¹

    ws.onmessage = function(event) {
        const response = event.data;

        // æ£€æŸ¥æ˜¯å¦æ˜¯JSONæ ¼å¼çš„æµå¼å“åº”æ•°æ®
        try {
            const data = JSON.parse(response);
            if (data.type === 'stream_chunk' || data.content_type || data.is_tool_call) {
                handleStreamChunk(data);
                return;
            }
        } catch (e) {
            // ä¸æ˜¯JSONæ ¼å¼ï¼ŒæŒ‰åŸé€»è¾‘å¤„ç†
        }

        // Check if this is the start of a new response
        if (response.includes("ğŸ¤– AI Agent is processing your request")) {
            hideTypingIndicator();
            isStreaming = true;
            currentStreamingSections = {}; // é‡ç½®æµå¼å†…å®¹åˆ†ç±»
            currentAIMessage = document.createElement('div');
            currentAIMessage.className = 'message ai streaming';
            currentAIMessage.innerHTML = `
                <div class="avatar">AI</div>
                <div class="message-content">
                    <div class="streaming-sections">${response}</div>
                    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            messagesDiv.appendChild(currentAIMessage);
            return;
        }

        // Check if this is processing time info
        if (response.includes("æ€»è€—æ—¶:")) {
            isStreaming = false;
            const timeMatch = response.match(/\*æ€»è€—æ—¶: ([0-9.]+)ç§’ \| LLMæ‰§è¡Œè€—æ—¶: ([0-9.]+)ç§’\*/);
            if (timeMatch && currentAIMessage) {
                const totalTime = timeMatch[1];
                const llmTime = timeMatch[2];
                const timeDiv = document.createElement('div');
                timeDiv.className = 'processing-time';
                timeDiv.innerHTML = `
                    <div>æ€»è€—æ—¶: ${totalTime}ç§’</div>
                    <div>LLMæ‰§è¡Œè€—æ—¶: ${llmTime}ç§’</div>
                `;
                currentAIMessage.querySelector('.message-content').appendChild(timeDiv);
            }
            currentAIMessage = null;
            currentStreamingSections = {};

            // Re-enable input after processing completes
            isProcessing = false;
            sendButton.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();

            scrollToBottom();
            return;
        }

        // Handle streaming content
        if (isStreaming && currentAIMessage) {
            const sectionsDiv = currentAIMessage.querySelector('.streaming-sections');
            if (sectionsDiv) {
                // åˆ›å»ºé»˜è®¤çš„æµå¼å†…å®¹åŒºåŸŸ
                if (!currentStreamingSections.default) {
                    const defaultSection = createStreamingSection('thinking', 'æ€è€ƒè¿‡ç¨‹');
                    sectionsDiv.appendChild(defaultSection);
                    currentStreamingSections.default = defaultSection.querySelector('.streaming-content');
                }
                // å°†\\næ›¿æ¢ä¸ºå®é™…çš„æ¢è¡Œç¬¦
                const formattedResponse = response.replace(/\\n/g, '<br />');
                currentStreamingSections.default.textContent += formattedResponse;
                scrollToBottom();
            }
        } else if (response.includes("ğŸ¤– AI Agent is processing your request")) {
            // Start of streaming output
            hideTypingIndicator();
            isStreaming = true;
            currentStreamingSections = {};
            currentAIMessage = document.createElement('div');
            currentAIMessage.className = 'message ai streaming';
            currentAIMessage.innerHTML = `
                <div class="avatar">AI</div>
                <div class="message-content">
                    <div class="streaming-sections"></div>
                    <div class="timestamp">${new Date().toLocaleTimeString()}</div>
                </div>
            `;
            messagesDiv.appendChild(currentAIMessage);
        } else if (isStreaming && currentAIMessage) {
            // Streaming content
            const sectionsDiv = currentAIMessage.querySelector('.streaming-sections');
            if (sectionsDiv) {
                // åˆ›å»ºé»˜è®¤çš„æµå¼å†…å®¹åŒºåŸŸ
                if (!currentStreamingSections.default) {
                    const defaultSection = createStreamingSection('thinking', 'æ€è€ƒè¿‡ç¨‹');
                    sectionsDiv.appendChild(defaultSection);
                    currentStreamingSections.default = defaultSection.querySelector('.streaming-content');
                }
                currentStreamingSections.default.textContent += response;
                scrollToBottom();
            }
        } else {
            // Fallback for non-streaming responses
            hideTypingIndicator();
            const timeMatch = response.match(/\\n\\n---\\n\*æ€»è€—æ—¶: ([0-9.]+)ç§’ \| LLMæ‰§è¡Œè€—æ—¶: ([0-9.]+)ç§’\*/);
            let messageContent = response;
            let totalTime = null;
            let llmTime = null;

            if (timeMatch) {
                totalTime = timeMatch[1];
                llmTime = timeMatch[2];
                messageContent = response.replace(/\\n\\n---\\n\*æ€»è€—æ—¶: [0-9.]+ç§’ \| LLMæ‰§è¡Œè€—æ—¶: [0-9.]+ç§’\*/, '');
            }

            addAIMessage(messageContent, totalTime, llmTime);

            // Re-enable input after processing completes
            isProcessing = false;
            sendButton.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        }
    };

    // å¤„ç†æµå¼åˆ†å—æ•°æ®
    function handleStreamChunk(data) {
        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–°çš„agentå“åº”ï¼ˆè¿­ä»£å¼€å§‹æˆ–æœ€ç»ˆç­”æ¡ˆï¼‰
        const isNewResponse = data.is_iteration_start || data.is_final_answer;

        // å¦‚æœæ˜¯æ–°çš„agentå“åº”æˆ–è€…è¿˜æ²¡æœ‰å¼€å§‹æµå¼ä¼ è¾“ï¼Œåˆ›å»ºæ–°æ¶ˆæ¯
        if (isNewResponse || !isStreaming) {
            hideTypingIndicator();
            isStreaming = true;
            currentStreamingSections = {};
            currentAIMessage = document.createElement('div');
            currentAIMessage.className = 'message ai streaming';

            // æ·»åŠ è¿­ä»£å’Œè€—æ—¶ä¿¡æ¯åˆ°æ¶ˆæ¯æ ‡é¢˜
            const iterationCount = data.iteration_count || 0;
            const duration = data.duration_from_start || 0;
            const timestamp = new Date().toLocaleTimeString();

            currentAIMessage.innerHTML = `
                <div class=\"avatar\">AI</div>
                <div class=\"message-content\">
                    <div class=\"message-header\">
                        <span class=\"iteration-info\">è¿­ä»£ ${iterationCount}</span>
                        <span class=\"duration-info\">è€—æ—¶: ${duration.toFixed(3)}ç§’</span>
                        <span class=\"timestamp\">${timestamp}</span>
                    </div>
                    <div class=\"streaming-sections\"></div>
                </div>
            `;
            messagesDiv.appendChild(currentAIMessage);
        }

        const sectionsDiv = currentAIMessage.querySelector('.streaming-sections');
        if (!sectionsDiv) return;

        // å¤„ç†å·¥å…·æ‰§è¡Œç»“æœ
        if (data.is_tool_call) {
            handleToolCallData(data, sectionsDiv);
            return;
        }

        // å¤„ç†çŸ¥è¯†åº“æŸ¥è¯¢ç»“æœ
        if (data.content_type === 'knowledge' || data.is_knowledge_query) {
            handleKnowledgeQueryData(data, sectionsDiv);
            return;
        }

        const contentType = data.content_type || 'reasoning';
        const content = data.content || '';
        const duration = data.duration_from_start || 0;

        // æ ¹æ®å†…å®¹ç±»å‹åˆ›å»ºæˆ–è·å–å¯¹åº”çš„åŒºåŸŸ
        if (!currentStreamingSections[contentType]) {
            const sectionTitle = getSectionTitle(contentType);
            const section = createStreamingSection(contentType, sectionTitle);
            sectionsDiv.appendChild(section);
            currentStreamingSections[contentType] = section.querySelector('.streaming-content');
        }

        // æ·»åŠ å†…å®¹åˆ°å¯¹åº”çš„åŒºåŸŸ
        if (currentStreamingSections[contentType]) {
            // å¯¹äºreasoningç±»å‹ï¼Œæ·»åŠ è€—æ—¶ä¿¡æ¯
            let displayContent = content;
            if (contentType === 'reasoning') {
                // ç›´æ¥ä½¿ç”¨duration_from_startå­—æ®µä½œä¸ºæ¯æ¬¡reasoningçš„è€—æ—¶
                const reasoningDuration = duration.toFixed(3);

                // æ¸…ç†å†…å®¹ï¼Œç§»é™¤é‡å¤çš„è€—æ—¶ä¿¡æ¯
                console.log('Original reasoning content:', content);
                const cleanContent = content.replace(/\\n\\*\\(è¿­ä»£: \\d+, è€—æ—¶: [0-9.]+ç§’\\*\\)/, '');

                displayContent = `${cleanContent}<div class=\"reasoning-duration\">æ€è€ƒè€—æ—¶: ${reasoningDuration}ç§’</div>`;
            }

            // å°†\\næ›¿æ¢ä¸ºå®é™…çš„æ¢è¡Œç¬¦
            const formattedContent = displayContent.replace(/\\n/g, '<br />');
            currentStreamingSections[contentType].innerHTML += formattedContent;
            scrollToBottom();
        }
    }

    // å¤„ç†å·¥å…·æ‰§è¡Œæ•°æ®
    function handleToolCallData(data, sectionsDiv) {
        // ç¡®ä¿tool_nameæ­£ç¡®è·å–ï¼Œæ·»åŠ è°ƒè¯•ä¿¡æ¯
        const toolName = data.tool_name || data.toolName || data.name || data.function_name || data.command || 'å·¥å…·';
        const toolStatus = data.tool_status || 'start';

        // æ›´æ™ºèƒ½çš„å·¥å…·å‘½ä»¤è·å–é€»è¾‘
        let tool_command = 'server not response';
        if (data.tool_args) {
            // å°è¯•å¤šç§å¯èƒ½çš„å‘½ä»¤å­—æ®µ
            tool_command = data.tool_args.command || data.tool_args.query || data.tool_args.path ||
                         data.tool_args.file || data.tool_args.function_name ||
                         JSON.stringify(data.tool_args, null, 2);
        }

        // è°ƒè¯•æ—¥å¿—
        console.log('Tool call data:', JSON.stringify(data, null, 2));
        console.log('Tool name:', toolName);
        console.log('Tool status:', toolStatus);
        console.log('Tool command:', tool_command);

        // åˆ›å»ºæˆ–è·å–å·¥å…·æ‰§è¡ŒåŒºåŸŸ
        if (!currentStreamingSections['tool_' + toolName]) {
            const toolSection = createToolSection(toolName);
            sectionsDiv.appendChild(toolSection);
            currentStreamingSections['tool_' + toolName] = toolSection.querySelector('.tool-content');
        }

        const toolContentDiv = currentStreamingSections['tool_' + toolName];
        if (!toolContentDiv) return;

        // æ ¹æ®å·¥å…·çŠ¶æ€æ›´æ–°æ˜¾ç¤º
        switch (toolStatus) {
            case 'start':
                // ç›´æ¥ä½¿ç”¨å·²ç»æ™ºèƒ½å¤„ç†è¿‡çš„å·¥å…·å‘½ä»¤
                toolContentDiv.innerHTML += `<div class=\"tool-status-start\">ğŸ”§ å¼€å§‹æ‰§è¡Œå·¥å…·: <strong>${tool_command}</strong></div>`;
                break;
            case 'completed':
                const duration = data.tool_duration ? data.tool_duration.toFixed(3) : 'æœªçŸ¥';
                const result = data.tool_result || 'æ— ç»“æœ';
                // å°†\\næ›¿æ¢ä¸ºå®é™…çš„æ¢è¡Œç¬¦
                const formattedResult = result.replace(/\\n/g, '\\n');
                toolContentDiv.innerHTML += `
                    <div class=\"tool-status-completed\">
                        âœ… å·¥å…·æ‰§è¡Œå®Œæˆ: <strong>${toolName}</strong>
                        <div class=\"tool-details\">
                            <div class=\"tool-duration\">æ‰§è¡Œè€—æ—¶: ${duration}ç§’</div>
                            <div class=\"tool-result\">æ‰§è¡Œç»“æœ: ${formattedResult}</div>
                        </div>
                    </div>
                `;
                break;
            case 'error':
                const errorMsg = data.tool_error || 'æœªçŸ¥é”™è¯¯';
                const errorDuration = data.tool_duration ? data.tool_duration.toFixed(3) : 'æœªçŸ¥';
                // å°†\\næ›¿æ¢ä¸ºå®é™…çš„æ¢è¡Œç¬¦
                const formattedErrorMsg = errorMsg.replace(/\\n/g, '<br />');
                toolContentDiv.innerHTML += `
                    <div class=\"tool-status-error\">
                        âŒ å·¥å…·æ‰§è¡Œå¤±è´¥: <strong>${toolName}</strong>
                        <div class=\"tool-details\">
                            <div class=\"tool-duration\">æ‰§è¡Œè€—æ—¶: ${errorDuration}ç§’</div>
                            <div class=\"tool-error\">é”™è¯¯ä¿¡æ¯: ${formattedErrorMsg}</div>
                        </div>
                    </div>
                `;
                break;
        }

        scrollToBottom();
    }

    // åˆ›å»ºå·¥å…·æ‰§è¡ŒåŒºåŸŸ
    function createToolSection(toolName) {
        const section = document.createElement('div');
        section.className = 'streaming-section streaming-section-tool';
        section.innerHTML = `
            <div class=\"section-header\">
                <span class=\"section-title\">å·¥å…·æ‰§è¡Œ: ${toolName}</span>
            </div>
            <div class=\"tool-content\"></div>
        `;
        return section;
    }

    // å¤„ç†çŸ¥è¯†åº“æŸ¥è¯¢æ•°æ®
    function handleKnowledgeQueryData(data, sectionsDiv) {
        const knowledgeStatus = data.knowledge_status || 'start';
        const knowledgeDomain = data.knowledge_domain || '';
        const knowledgeQuery = data.knowledge_query || '';
        const knowledgeCount = data.knowledge_count || 0;
        const knowledgeResult = data.knowledge_result || '';

        // è°ƒè¯•æ—¥å¿—
        console.log('Knowledge query data:', JSON.stringify(data, null, 2));
        console.log('Knowledge status:', knowledgeStatus);
        console.log('Knowledge domain:', knowledgeDomain);
        console.log('Knowledge query:', knowledgeQuery);

        // åˆ›å»ºæˆ–è·å–çŸ¥è¯†åº“æŸ¥è¯¢åŒºåŸŸ
        if (!currentStreamingSections['knowledge']) {
            const knowledgeSection = createKnowledgeSection();
            sectionsDiv.appendChild(knowledgeSection);
            currentStreamingSections['knowledge'] = knowledgeSection.querySelector('.knowledge-content');
        }

        const knowledgeContentDiv = currentStreamingSections['knowledge'];
        if (!knowledgeContentDiv) return;

        // æ ¹æ®çŸ¥è¯†åº“æŸ¥è¯¢çŠ¶æ€æ›´æ–°æ˜¾ç¤º
        switch (knowledgeStatus) {
            case 'start':
                knowledgeContentDiv.innerHTML += `<div class=\"knowledge-status-start\">ğŸ“š ${data.content}</div>`;
                break;
            case 'searching':
                knowledgeContentDiv.innerHTML += `
                    <div class=\"knowledge-status-searching\">
                        ğŸ” ${data.content}
                        <div class=\"knowledge-details\">
                            <div class=\"knowledge-query-info\">æŸ¥è¯¢é¢†åŸŸ: ${knowledgeDomain}</div>
                            <div class=\"knowledge-query-info\">æŸ¥è¯¢å…³é”®è¯: ${knowledgeQuery}</div>
                        </div>
                    </div>
                `;
                break;
            case 'success':
                const formattedResult = knowledgeResult.replace(/\\n/g, '\\n');
                const previewLinksId = `knowledge-preview-links-${Date.now()}`;
                knowledgeContentDiv.innerHTML += `
                    <div class=\"knowledge-status-success\">
                        âœ… ${data.content} <span class=\"knowledge-count\">${knowledgeCount}</span>
                        <div class=\"knowledge-details\">
                            <div class=\"knowledge-result\">${formattedResult}</div>
                            <div class=\"knowledge-preview-links\" id=\"${previewLinksId}\"></div>
                        </div>
                    </div>
                `;
                
                // ä½¿ç”¨æ–°çš„é¢„è§ˆé¡¹ç›®æ•°ç»„ç”Ÿæˆé¢„è§ˆé“¾æ¥
                setTimeout(() => {
                    if (data.preview_items && data.preview_items.length > 0) {
                        createPreviewLinksFromArray(data.preview_items, previewLinksId);
                    } else {
                        // å…¼å®¹æ—§çš„è§£ææ–¹å¼
                        parseKnowledgeResultsForPreview(formattedResult, previewLinksId);
                    }
                }, 100);
                break;
            case 'no_results':
                knowledgeContentDiv.innerHTML += `<div class=\"knowledge-status-no-results\">ğŸ“­ ${data.content}</div>`;
                break;
            case 'error':
                knowledgeContentDiv.innerHTML += `<div class=\"knowledge-status-error\">âŒ ${data.content}</div>`;
                break;
            case 'skipped':
                knowledgeContentDiv.innerHTML += `<div class=\"knowledge-status-skipped\">âš ï¸ ${data.content}</div>`;
                break;
            default:
                knowledgeContentDiv.innerHTML += `<div class=\"knowledge-status-start\">ğŸ“š ${data.content}</div>`;
                break;
        }

        scrollToBottom();
    }

    // åˆ›å»ºçŸ¥è¯†åº“æŸ¥è¯¢åŒºåŸŸ
    function createKnowledgeSection() {
        const section = document.createElement('div');
        section.className = 'streaming-section streaming-section-knowledge';
        section.innerHTML = `
            <div class=\"section-header\">
                <span class=\"section-title\">çŸ¥è¯†åº“æŸ¥è¯¢</span>
            </div>
            <div class=\"knowledge-content\"></div>
        `;
        return section;
    }

    // è·å–å†…å®¹ç±»å‹çš„æ˜¾ç¤ºæ ‡é¢˜
    function getSectionTitle(contentType) {
        const titles = {
            'reasoning': 'æ€è€ƒè¿‡ç¨‹',
            'thinking': 'æ€è€ƒè¿‡ç¨‹',
            'tool': 'å·¥å…·æ‰§è¡Œ',
            'answer': 'æœ€ç»ˆå›ç­”',
            'knowledge': 'çŸ¥è¯†åº“æŸ¥è¯¢',
            'default': 'å¤„ç†è¿‡ç¨‹'
        };
        return titles[contentType] || titles['default'];
    }

    // è§£æçŸ¥è¯†åº“ç»“æœä¸­çš„æ–‡æ¡£é“¾æ¥å¹¶æ·»åŠ é¢„è§ˆåŠŸèƒ½
    function parseKnowledgeResultsForPreview(resultHtml, containerId) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥è§£æHTML
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = resultHtml;
        
        // æŸ¥æ‰¾æ‰€æœ‰åŒ…å«é¢„è§ˆä¿¡æ¯çš„çŸ¥è¯†æ¡ç›®
        const knowledgeItems = tempDiv.querySelectorAll('h3');
        
        knowledgeItems.forEach((item, index) => {
            // è·å–æ•´ä¸ªçŸ¥è¯†æ¡ç›®çš„æ–‡æœ¬å†…å®¹
            let currentElement = item;
            let itemText = '';
            
            // æ”¶é›†ä»h3å¼€å§‹åˆ°ä¸‹ä¸€ä¸ªh3æˆ–ç»“æŸçš„æ‰€æœ‰æ–‡æœ¬
            while (currentElement && currentElement.nextSibling) {
                currentElement = currentElement.nextSibling;
                if (currentElement.nodeType === Node.TEXT_NODE) {
                    itemText += currentElement.textContent;
                } else if (currentElement.nodeType === Node.ELEMENT_NODE) {
                    if (currentElement.tagName === 'H3') {
                        break; // é‡åˆ°ä¸‹ä¸€ä¸ªh3å°±åœæ­¢
                    }
                    itemText += currentElement.textContent || '';
                }
            }
            
            // æ£€æŸ¥å„ç§ç±»å‹çš„é¢„è§ˆä¿¡æ¯
            const docLinkMatch = itemText.match(/ğŸ“„ æ–‡æ¡£é“¾æ¥[:ï¼š]\s*([^\n|]+)/);
            const filePathMatch = itemText.match(/ğŸ“ æ–‡ä»¶è·¯å¾„[:ï¼š]\s*([^\n|]+)/);
            const itemIdMatch = itemText.match(/ğŸ†” æ¡ç›®ID[:ï¼š]\s*([^\n|]+)/);
            const previewAvailableMatch = itemText.match(/ğŸ” æ”¯æŒé¢„è§ˆ/);
            
            // åˆ›å»ºé¢„è§ˆé“¾æ¥å®¹å™¨
            const previewContainer = document.createElement('div');
            previewContainer.className = 'preview-links-container';
            previewContainer.style.cssText = `
                margin-top: 10px;
                padding: 8px;
                background: rgba(66, 153, 225, 0.1);
                border-radius: 4px;
                border-left: 3px solid #4299e1;
            `;
            
            let hasPreviewOptions = false;
            
            // æ·»åŠ æ–‡æ¡£é“¾æ¥é¢„è§ˆ
            if (docLinkMatch) {
                const linkText = docLinkMatch[1].trim();
                const previewLink = createPreviewLink('ğŸ“„ é¢„è§ˆæ–‡æ¡£é“¾æ¥', linkText, 'url', index);
                previewContainer.appendChild(previewLink);
                hasPreviewOptions = true;
            }
            
            // æ·»åŠ æ–‡ä»¶è·¯å¾„é¢„è§ˆ
            if (filePathMatch) {
                const pathText = filePathMatch[1].trim();
                const previewLink = createPreviewLink('ğŸ“ é¢„è§ˆæ–‡ä»¶å†…å®¹', pathText, 'file', index);
                previewContainer.appendChild(previewLink);
                hasPreviewOptions = true;
            }
            
            // æ·»åŠ çŸ¥è¯†æ¡ç›®å®Œæ•´å†…å®¹é¢„è§ˆ
            if (itemIdMatch && previewAvailableMatch) {
                const itemId = itemIdMatch[1].trim();
                const previewLink = createPreviewLink('ğŸ” é¢„è§ˆå®Œæ•´å†…å®¹', itemId, 'item', index);
                previewContainer.appendChild(previewLink);
                hasPreviewOptions = true;
            }
            
            // å¦‚æœæœ‰é¢„è§ˆé€‰é¡¹ï¼Œæ·»åŠ åˆ°å®¹å™¨ä¸­
            if (hasPreviewOptions) {
                container.appendChild(previewContainer);
            }
        });
    }
    
    // ä½¿ç”¨é¢„è§ˆé¡¹ç›®æ•°ç»„åˆ›å»ºé¢„è§ˆé“¾æ¥
    function createPreviewLinksFromArray(previewItems, containerId) {
        const container = document.getElementById(containerId);
        if (!container || !previewItems || previewItems.length === 0) return;
        
        // åˆ›å»ºé¢„è§ˆé“¾æ¥å®¹å™¨
        const previewContainer = document.createElement('div');
        previewContainer.className = 'preview-links-container';
        previewContainer.style.cssText = `
            margin-top: 10px;
            padding: 8px;
            background: rgba(66, 153, 225, 0.1);
            border-radius: 4px;
            border-left: 3px solid #4299e1;
        `;
        
        // ä¸ºæ¯ä¸ªé¢„è§ˆé¡¹ç›®åˆ›å»ºé“¾æ¥
        previewItems.forEach((item, index) => {
            const previewLink = document.createElement('a');
            previewLink.href = '#';
            previewLink.className = 'doc-preview-link';
            previewLink.style.cssText = `
                display: inline-block;
                margin: 2px 5px 2px 0;
                padding: 4px 8px;
                background: #4299e1;
                color: white;
                text-decoration: none;
                border-radius: 3px;
                font-size: 0.85rem;
                transition: background-color 0.2s;
            `;
            
            previewLink.textContent = item.label;
            previewLink.dataset.type = item.type;
            previewLink.dataset.id = item.id;
            previewLink.dataset.index = index;
            
            // æ ¹æ®ç±»å‹è®¾ç½®é¢å¤–çš„æ•°æ®å±æ€§
            if (item.type === 'file' && item.path) {
                previewLink.dataset.path = item.path;
            } else if (item.type === 'url' && item.url) {
                previewLink.dataset.url = item.url;
            } else if (item.type === 'item' && item.item_id) {
                previewLink.dataset.itemId = item.item_id;
            }
            
            previewLink.addEventListener('click', function(e) {
                e.preventDefault();
                showDocumentPreviewFromArray(this.dataset);
            });
            
            previewLink.addEventListener('mouseenter', function() {
                this.style.background = '#3182ce';
            });
            
            previewLink.addEventListener('mouseleave', function() {
                this.style.background = '#4299e1';
            });
            
            previewContainer.appendChild(previewLink);
        });
        
        container.appendChild(previewContainer);
    }
    
    // åˆ›å»ºé¢„è§ˆé“¾æ¥
    function createPreviewLink(text, link, type, index) {
        const previewLink = document.createElement('a');
        previewLink.href = '#';
        previewLink.className = 'doc-preview-link';
        previewLink.style.cssText = `
            display: inline-block;
            margin: 2px 5px 2px 0;
            padding: 4px 8px;
            background: #4299e1;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: background 0.2s;
        `;
        previewLink.textContent = text;
        previewLink.dataset.link = link;
        previewLink.dataset.type = type;
        previewLink.dataset.index = index;
        
        previewLink.addEventListener('click', function(e) {
            e.preventDefault();
            showDocumentPreview(this.dataset.link, this.dataset.type, this.dataset.index);
        });
        
        previewLink.addEventListener('mouseenter', function() {
            this.style.background = '#3182ce';
        });
        
        previewLink.addEventListener('mouseleave', function() {
            this.style.background = '#4299e1';
        });
        
        return previewLink;
    }

    // æ˜¾ç¤ºæ–‡æ¡£é¢„è§ˆæ¨¡æ€æ¡†
    function showDocumentPreview(link, type, index) {
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'doc-preview-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        `;
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const content = document.createElement('div');
        content.className = 'doc-preview-content';
        content.style.cssText = `
            background: white;
            padding: 0;
            border-radius: 12px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
        `;
        
        // åˆ›å»ºå¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            background: #f8fafc;
            border-radius: 12px 12px 0 0;
        `;
        
        // æ·»åŠ å…³é—­æŒ‰é’®
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'Ã—';
        closeBtn.style.cssText = `
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #718096;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        `;
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#e2e8f0';
            closeBtn.style.color = '#2d3748';
        });
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#718096';
        });
        closeBtn.addEventListener('click', () => {
            modal.style.animation = 'fadeOut 0.2s ease-out';
            setTimeout(() => document.body.removeChild(modal), 200);
        });
        
        // æ·»åŠ æ ‡é¢˜å’Œæ¥æºä¿¡æ¯
        const title = document.createElement('h3');
        title.style.cssText = `
            margin: 0 40px 10px 0;
            color: #2d3748;
            font-size: 1.2rem;
        `;
        
        const typeNames = {
            'url': 'æ–‡æ¡£é“¾æ¥',
            'file': 'æœ¬åœ°æ–‡ä»¶',
            'item': 'çŸ¥è¯†æ¡ç›®'
        };
        title.textContent = `${typeNames[type] || 'æ–‡æ¡£'}é¢„è§ˆ`;
        
        const linkInfo = document.createElement('p');
        linkInfo.style.cssText = `
            margin: 0;
            color: #718096;
            font-size: 0.9rem;
            word-break: break-all;
        `;
        linkInfo.textContent = `æ¥æº: ${link}`;
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const contentArea = document.createElement('div');
        contentArea.className = 'doc-preview-text';
        contentArea.style.cssText = `
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: white;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            word-wrap: break-word;
        `;
        
        // æ·»åŠ åŠ è½½çŠ¶æ€
        contentArea.innerHTML = `
            <div style="text-align: center; padding: 40px; color: #718096;">
                <div style="display: inline-block; width: 20px; height: 20px; border: 2px solid #e2e8f0; border-top: 2px solid #4299e1; border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 10px;"></div>
                <div>æ­£åœ¨åŠ è½½æ–‡æ¡£å†…å®¹...</div>
            </div>
        `;
        
        // ç»„è£…æ¨¡æ€æ¡†
        header.appendChild(title);
        header.appendChild(linkInfo);
        content.appendChild(closeBtn);
        content.appendChild(header);
        content.appendChild(contentArea);
        modal.appendChild(content);
        
        // æ·»åŠ CSSåŠ¨ç”»
        const style = document.createElement('style');
        style.textContent = `
            @keyframes fadeIn {
                from { opacity: 0; transform: scale(0.9); }
                to { opacity: 1; transform: scale(1); }
            }
            @keyframes fadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
            @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
        
        // æ·»åŠ åˆ°é¡µé¢
        document.body.appendChild(modal);
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => document.body.removeChild(modal), 200);
            }
        });
        
        // ESCé”®å…³é—­
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.style.animation = 'fadeOut 0.2s ease-out';
                setTimeout(() => document.body.removeChild(modal), 200);
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // åŠ è½½æ–‡æ¡£å†…å®¹
        loadDocumentContent(link, type, contentArea);
    }

    // åŠ è½½æ–‡æ¡£å†…å®¹ï¼ˆéœ€è¦åç«¯APIæ”¯æŒï¼‰
    function loadDocumentContent(link, type, contentArea) {
        // è°ƒç”¨åç«¯APIè·å–æ–‡æ¡£å†…å®¹
        const params = new URLSearchParams();
        
        if (type === 'url') {
            params.append('source_url', link);
        } else if (type === 'file') {
            params.append('file_path', link);
        } else if (type === 'item') {
            params.append('item_id', link);
        }
        
        fetch(`/api/knowledge/preview?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // æˆåŠŸåŠ è½½å†…å®¹
                    contentArea.innerHTML = '';
                    
                    // å¦‚æœæœ‰å…ƒæ•°æ®ï¼Œæ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
                    if (data.metadata && type === 'item') {
                        const metadataDiv = document.createElement('div');
                        metadataDiv.style.cssText = `
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                            border-left: 4px solid #4299e1;
                        `;
                        
                        const metadataHtml = `
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">ğŸ“‹ æ–‡æ¡£ä¿¡æ¯</div>
                            <div style="font-size: 0.9rem; color: #4a5568; line-height: 1.4;">
                                <div><strong>æ ‡é¢˜:</strong> ${data.metadata.title || 'æ— æ ‡é¢˜'}</div>
                                <div><strong>é¢†åŸŸ:</strong> ${data.metadata.domain || 'æœªçŸ¥'}</div>
                                <div><strong>åˆ†ç±»:</strong> ${data.metadata.category || 'æœªçŸ¥'}</div>
                                <div><strong>æ ‡ç­¾:</strong> ${(data.metadata.tags || []).join(', ') || 'æ— æ ‡ç­¾'}</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${data.metadata.created_at ? new Date(data.metadata.created_at).toLocaleString() : 'æœªçŸ¥'}</div>
                                ${data.metadata.source_url ? `<div><strong>åŸå§‹é“¾æ¥:</strong> ${data.metadata.source_url}</div>` : ''}
                                ${data.metadata.file_path ? `<div><strong>æ–‡ä»¶è·¯å¾„:</strong> ${data.metadata.file_path}</div>` : ''}
                            </div>
                        `;
                        metadataDiv.innerHTML = metadataHtml;
                        contentArea.appendChild(metadataDiv);
                    }
                    
                    // æ˜¾ç¤ºæ–‡æ¡£å†…å®¹
                    const contentDiv = document.createElement('div');
                    contentDiv.style.cssText = `
                        background: #ffffff;
                        padding: 15px;
                        border-radius: 6px;
                        border: 1px solid #e2e8f0;
                        white-space: pre-wrap;
                        word-wrap: break-word;
                        line-height: 1.6;
                    `;
                    
                    // ç®€å•çš„å†…å®¹æ ¼å¼åŒ–
                    let formattedContent = data.content;
                    
                    // æ£€æµ‹å¹¶é«˜äº®ä»£ç å—
                    if (formattedContent.includes('```')) {
                        formattedContent = formattedContent.replace(
                            /```(\w+)?\n([\s\S]*?)```/g,
                            '<div style="background: #f1f5f9; padding: 10px; border-radius: 4px; margin: 10px 0; border-left: 3px solid #64748b;"><code style="font-family: Monaco, monospace; font-size: 0.9rem;">$2</code></div>'
                        );
                    }
                    
                    // é«˜äº®æ ‡é¢˜
                    formattedContent = formattedContent.replace(
                        /^(#{1,6})\s+(.+)$/gm,
                        '<div style="font-weight: 600; color: #2d3748; margin: 15px 0 8px 0; font-size: 1.1rem;">$2</div>'
                    );
                    
                    // é«˜äº®é‡è¦ä¿¡æ¯
                    formattedContent = formattedContent.replace(
                        /\*\*(.*?)\*\*/g,
                        '<strong style="color: #2d3748;">$1</strong>'
                    );
                    
                    contentDiv.innerHTML = formattedContent;
                    contentArea.appendChild(contentDiv);
                    
                } else {
                    // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
                    contentArea.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">æ–‡æ¡£é¢„è§ˆå¤±è´¥</div>
                            <div style="color: #718096;">${data.message || 'æœªçŸ¥é”™è¯¯'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e53e3e;">
                        <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”Œ</div>
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">ç½‘ç»œè¯·æ±‚å¤±è´¥</div>
                        <div style="color: #718096;">${error.message}</div>
                    </div>
                `;
            });
    }

    // ä½¿ç”¨é¢„è§ˆé¡¹ç›®æ•°ç»„æ˜¾ç¤ºæ–‡æ¡£é¢„è§ˆ
    function showDocumentPreviewFromArray(dataset) {
        const type = dataset.type;
        const id = dataset.id;
        
        // åˆ›å»ºæ¨¡æ€æ¡†
        const modal = document.createElement('div');
        modal.className = 'doc-preview-modal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease-out;
        `;
        
        // åˆ›å»ºå†…å®¹å®¹å™¨
        const content = document.createElement('div');
        content.className = 'doc-preview-content';
        content.style.cssText = `
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 900px;
            height: 80%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease-out;
        `;
        
        // åˆ›å»ºå¤´éƒ¨
        const header = document.createElement('div');
        header.style.cssText = `
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #f8fafc;
            border-radius: 8px 8px 0 0;
        `;
        
        const title = document.createElement('h3');
        title.style.cssText = `
            margin: 0;
            color: #2d3748;
            font-size: 1.2rem;
        `;
        
        const typeNames = {
            'file': 'æ–‡ä»¶',
            'url': 'æ–‡æ¡£é“¾æ¥',
            'item': 'å®Œæ•´å†…å®¹'
        };
        title.textContent = `${typeNames[type] || 'æ–‡æ¡£'}é¢„è§ˆ`;
        
        const closeBtn = document.createElement('button');
        closeBtn.innerHTML = 'âœ•';
        closeBtn.style.cssText = `
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #718096;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        `;
        
        closeBtn.addEventListener('click', () => {
            document.body.removeChild(modal);
        });
        
        closeBtn.addEventListener('mouseenter', () => {
            closeBtn.style.background = '#e2e8f0';
            closeBtn.style.color = '#2d3748';
        });
        
        closeBtn.addEventListener('mouseleave', () => {
            closeBtn.style.background = 'none';
            closeBtn.style.color = '#718096';
        });
        
        header.appendChild(title);
        header.appendChild(closeBtn);
        
        // åˆ›å»ºå†…å®¹åŒºåŸŸ
        const contentArea = document.createElement('div');
        contentArea.className = 'doc-preview-text';
        contentArea.style.cssText = `
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            color: #2d3748;
            background: #fafafa;
        `;
        
        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        contentArea.innerHTML = `
            <div style="display: flex; align-items: center; justify-content: center; height: 200px;">
                <div style="text-align: center;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">ğŸ“„</div>
                    <div style="color: #718096;">æ­£åœ¨åŠ è½½æ–‡æ¡£å†…å®¹...</div>
                </div>
            </div>
        `;
        
        content.appendChild(header);
        content.appendChild(contentArea);
        modal.appendChild(content);
        document.body.appendChild(modal);
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                document.body.removeChild(modal);
            }
        });
        
        // ESCé”®å…³é—­
        const handleEsc = (e) => {
            if (e.key === 'Escape') {
                document.body.removeChild(modal);
                document.removeEventListener('keydown', handleEsc);
            }
        };
        document.addEventListener('keydown', handleEsc);
        
        // åŠ è½½æ–‡æ¡£å†…å®¹
        loadDocumentContentFromArray(dataset, contentArea);
    }

    // ä½¿ç”¨é¢„è§ˆé¡¹ç›®æ•°æ®åŠ è½½æ–‡æ¡£å†…å®¹
    function loadDocumentContentFromArray(dataset, contentArea) {
        const type = dataset.type;
        const params = new URLSearchParams();
        
        // æ ¹æ®ç±»å‹è®¾ç½®ä¸åŒçš„å‚æ•°
        if (type === 'file' && dataset.path) {
            params.append('file_path', dataset.path);
        } else if (type === 'url' && dataset.url) {
            params.append('source_url', dataset.url);
        } else if (type === 'item' && dataset.itemId) {
            params.append('item_id', dataset.itemId);
        } else {
            contentArea.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #e53e3e;">
                    <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">å‚æ•°é”™è¯¯</div>
                    <div style="color: #718096;">æ— æ•ˆçš„é¢„è§ˆå‚æ•°</div>
                </div>
            `;
            return;
        }
        
        fetch(`/api/knowledge/preview?${params}`)
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // æ ¼å¼åŒ–å†…å®¹æ˜¾ç¤º
                    const formattedContent = data.content
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/\\n/g, '<br>')
                        .replace(/\\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;');
                    
                    contentArea.innerHTML = `<pre style="white-space: pre-wrap; margin: 0;">${formattedContent}</pre>`;
                    
                    // å¦‚æœæœ‰å…ƒæ•°æ®ï¼Œæ˜¾ç¤ºå…ƒæ•°æ®ä¿¡æ¯
                    if (data.metadata && type === 'item') {
                        const metadataDiv = document.createElement('div');
                        metadataDiv.style.cssText = `
                            background: #f8fafc;
                            padding: 15px;
                            border-radius: 6px;
                            margin-bottom: 15px;
                            border-left: 4px solid #4299e1;
                        `;
                        
                        const metadataHtml = `
                            <div style="font-weight: 600; color: #2d3748; margin-bottom: 8px;">ğŸ“‹ æ–‡æ¡£ä¿¡æ¯</div>
                            <div style="font-size: 0.9rem; color: #4a5568; line-height: 1.4;">
                                <div><strong>æ ‡é¢˜:</strong> ${data.metadata.title || 'æ— æ ‡é¢˜'}</div>
                                <div><strong>é¢†åŸŸ:</strong> ${data.metadata.domain || 'æœªçŸ¥'}</div>
                                <div><strong>åˆ†ç±»:</strong> ${data.metadata.category || 'æœªçŸ¥'}</div>
                                <div><strong>æ ‡ç­¾:</strong> ${(data.metadata.tags || []).join(', ') || 'æ— æ ‡ç­¾'}</div>
                                <div><strong>åˆ›å»ºæ—¶é—´:</strong> ${data.metadata.created_at ? new Date(data.metadata.created_at).toLocaleString() : 'æœªçŸ¥'}</div>
                                ${data.metadata.source_url ? `<div><strong>åŸå§‹é“¾æ¥:</strong> ${data.metadata.source_url}</div>` : ''}
                                ${data.metadata.file_path ? `<div><strong>æ–‡ä»¶è·¯å¾„:</strong> ${data.metadata.file_path}</div>` : ''}
                            </div>
                        `;
                        
                        metadataDiv.innerHTML = metadataHtml;
                        contentArea.insertBefore(metadataDiv, contentArea.firstChild);
                    }
                } else {
                    contentArea.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #e53e3e;">
                            <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">æ–‡æ¡£é¢„è§ˆå¤±è´¥</div>
                            <div style="color: #718096;">${data.message || 'æœªçŸ¥é”™è¯¯'}</div>
                        </div>
                    `;
                }
            })
            .catch(error => {
                contentArea.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #e53e3e;">
                        <div style="font-size: 1.1rem; font-weight: 600; margin-bottom: 8px;">ç½‘ç»œè¯·æ±‚å¤±è´¥</div>
                        <div style="color: #718096;">${error.message}</div>
                    </div>
                `;
            });
    }

    // åˆ›å»ºæµå¼å†…å®¹åŒºåŸŸ
    function createStreamingSection(type, title) {
        const section = document.createElement('div');
        section.className = `streaming-section streaming-section-${type}`;
        section.innerHTML = `
            <div class="section-header">
                <span class="section-title">${title}</span>
            </div>
            <div class="streaming-content"></div>
        `;
        return section;
    }
    function sendMessage() {
        if (isProcessing) {
            return; // æ­£åœ¨å¤„ç†ä¸­ï¼Œä¸å…è®¸å‘é€æ–°æ¶ˆæ¯
        }

        const message = messageInput.value.trim();
        if (message && ws.readyState === WebSocket.OPEN) {
            isProcessing = true; // æ ‡è®°ä¸ºæ­£åœ¨å¤„ç†
            sendButton.disabled = true; // ç¦ç”¨å‘é€æŒ‰é’®
            messageInput.disabled = true; // ç¦ç”¨è¾“å…¥æ¡†

            addUserMessage(message);
            showTypingIndicator();
            ws.send(message);
            messageInput.value = '';
        }
    }

    // Enter key to send
    messageInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    // Auto-focus input
    messageInput.focus();

    // Handle WebSocket connection status
    ws.onopen = function() {
        sendButton.disabled = false;
    };

    ws.onclose = function() {
        sendButton.disabled = true;
        messageInput.disabled = true;
        addAIMessage("Connection lost. Please refresh the page.");

        // è¿æ¥æ–­å¼€æ—¶é‡ç½®å¤„ç†çŠ¶æ€
        isProcessing = false;
    };
</script>
</body>
</html>